# works only sometimes don't know why
# http://timisoaractf.ro [ CTF Website ]
import socket

def get_encoding(byte):
    h = hex(byte%0xff)[2:]
    if len(h) == 1: h = "0"+h
    return h

# Connection and Banner Print
s = socket.socket()
s.connect(("89.38.208.143", 21022))
m = s.recv(1024).decode()
print(m)

# Get the cipher to decode
cipher = m[-83:-57].strip().split()

i = 0 
decipher = []
while i < 8:
    decipher_text = "".join(decipher) # decipher text to encrypt
    print("decipher text:", decipher_text+"!")
    s.send((decipher_text+"!\n").encode())
    enc = s.recv(1024).decode() # recv encrypted text
    print(enc)
    enc_byte = int(enc[i*3+18:i*3+20].strip(), 16) # extract latest byte to bruteforce
    print("encrypted_byte:", hex(enc_byte)[2:])
    local_enc_byte = get_encoding(enc_byte)

    # Brute force by incrementing byte by 8 and checking against corresponding cipher value
    for j in range(94): # only printable chars
        if cipher[i] != local_enc_byte:
            #print("[-] {}".format(local_enc_byte))
            enc_byte += 0x8
            local_enc_byte = get_encoding(enc_byte)
        else:
            decipher.append(chr(ord("!")+j))
            break

    # found deciphered character
    print("[+] {}: {}\n".format(cipher[i], decipher[i]))
    i += 1

# sending bytes of the deciphered text
s.send(b"\n")
decipher = "".join(decipher)+"\n"
print(decipher.encode())
m = s.recv(1024).decode()
print(m)
s.send(decipher.encode())
print(s.recv(1024).decode())
